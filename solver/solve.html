<!doctype html>
<html>
<head>
 <title> Cube Solver </title>
 <meta name="author" content="Michael Feather">
 <meta name="robots" content="nofollow">
 <link rel=icon href=../mini_cube.png type=image/png>
 <link rel="stylesheet" type="text/css" href="../style2.css">
 <meta name=viewport content="width=device-width, initial-scale=1">
 <script src=../AnimCube3.js></script>
 <script src=../rch.js></script>
 <script src=../rclib.js></script>
 <script src=../verify.js></script>
 <script src=readfiles.js></script>
 <style> 
  div.wrap {
    height:100%;
    overflow:auto;
    padding:0px 5%; }
  .sbtn {
    height:28px;
    width:74px;
    border-radius:15px;
    background-color:#ffffff;
    padding:0px;
    border:none;
    outline:none;
  }
 </style>
</head>
<body ondblclick="fullScreen(event)">
<div class=wrap>
<center>
<style> input { height:22px; width:22px;} </style>
<script>
if (typeof(Worker) == "undefined") {
  document.write('This browser does not appear to support web workers<br>');
  document.write('Try this link instead: <a href=../solver_nw/index.html>Alt Solver</a>');
}
</script>
<table>
<tr><td height=8></tr>
<tr><td valign=top>
<font size=+2> Cube Solver </font>
<table border=0 style=line-height:0>
  <tr height=8>
  <tr>
    <td colspan=4></td>
    <td> <input id=f0 type=button onclick=set_color(this)> </td>
    <td> <input id=f1 type=button onclick=set_color(this)> </td>
    <td> <input id=f2 type=button onclick=set_color(this)> </td>
    <td colspan=2>
    <td colspan=5 rowspan=3 align=center>
      <table border=0>
        <tr height=5> </tr>
        <tr>
          <td width=3>
          <td> <input type=button id=R onclick=select_color(this) 
                      style="background-color:red;"> </td>
          <td> <input type=button id=Y onclick=select_color(this) 
                      style="background-color:yellow;"> </td>
          <td> <input type=button id=B onclick=select_color(this) 
                      style="background-color:blue;"> </td>
        </tr>
        <tr>
          <td>
          <td> <input type=button id=O onclick=select_color(this) 
                      style="background-color:orange"> </td>
          <td> <input type=button id=W onclick=select_color(this) 
                      style="background-color:white"> </td>
          <td> <input type=button id=G onclick=select_color(this) 
                      style="background-color:green"> </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr> 
    <td colspan=4></td>
    <td> <input id=f3 type=button onclick=set_color(this)> </td>
    <td> <input id=f4 type=button onclick=set_color(this)> </td> 
    <td> <input id=f5 type=button onclick=set_color(this)> </td>
  </tr>
  <tr> 
    <td colspan=4></td>
    <td> <input id=f6 type=button onclick=set_color(this)> </td>
    <td> <input id=f7 type=button onclick=set_color(this)> </td>
    <td> <input id=f8 type=button onclick=set_color(this)> </td>
  </tr>
  <tr height=10> </tr>
  <tr>
    <td> <input id=f9 type=button onclick=set_color(this)> </td>
    <td> <input id=f10 type=button onclick=set_color(this)> </td>
    <td> <input id=f11 type=button onclick=set_color(this)> </td>
    <td width=12> </td>
    <td> <input id=f12 type=button onclick=set_color(this)> </td>
    <td> <input id=f13 type=button onclick=set_color(this)> </td>
    <td> <input id=f14 type=button onclick=set_color(this)> </td>
    <td width=12> </td>
    <td> <input id=f15 type=button onclick=set_color(this)> </td>
    <td> <input id=f16 type=button onclick=set_color(this)> </td>
    <td> <input id=f17 type=button onclick=set_color(this)> </td>
    <td width=12> </td>
    <td> <input id=f18 type=button onclick=set_color(this)> </td>
    <td> <input id=f19 type=button onclick=set_color(this)> </td>
    <td> <input id=f20 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td> <input id=f21 type=button onclick=set_color(this)> </td>
    <td> <input id=f22 type=button onclick=set_color(this)> </td>
    <td> <input id=f23 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f24 type=button onclick=set_color(this)> </td>
    <td> <input id=f25 type=button onclick=set_color(this)> </td>
    <td> <input id=f26 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f27 type=button onclick=set_color(this)> </td>
    <td> <input id=f28 type=button onclick=set_color(this)> </td>
    <td> <input id=f29 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f30 type=button onclick=set_color(this)> </td>
    <td> <input id=f31 type=button onclick=set_color(this)> </td>
    <td> <input id=f32 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td> <input id=f33 type=button onclick=set_color(this)> </td>
    <td> <input id=f34 type=button onclick=set_color(this)> </td>
    <td> <input id=f35 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f36 type=button onclick=set_color(this)> </td>
    <td> <input id=f37 type=button onclick=set_color(this)> </td>
    <td> <input id=f38 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f39 type=button onclick=set_color(this)> </td>
    <td> <input id=f40 type=button onclick=set_color(this)> </td>
    <td> <input id=f41 type=button onclick=set_color(this)> </td>
    <td> </td>
    <td> <input id=f42 type=button onclick=set_color(this)> </td>
    <td> <input id=f43 type=button onclick=set_color(this)> </td>
    <td> <input id=f44 type=button onclick=set_color(this)> </td>
  </tr>
  <tr height=10> </tr>
  <tr>
    <td colspan=4></td>
    <td> <input id=f45 type=button onclick=set_color(this)> </td>
    <td> <input id=f46 type=button onclick=set_color(this)> </td>
    <td> <input id=f47 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td colspan=4></td>
    <td> <input id=f48 type=button onclick=set_color(this)> </td>
    <td> <input id=f49 type=button onclick=set_color(this)> </td>
    <td> <input id=f50 type=button onclick=set_color(this)> </td>
  </tr>
  <tr>
    <td colspan=4></td>
    <td> <input id=f51 type=button onclick=set_color(this)> </td>
    <td> <input id=f52 type=button onclick=set_color(this)> </td>
    <td> <input id=f53 type=button onclick=set_color(this)> </td>
  </tr>
</table>

<table border=0>
  <tr height=14>
  <tr>
    <td> <button class="btn svw1" onclick="home()">Home</button> </td>
    <td width=5>
    <td> <button class="btn svw1" onclick="show()">Show</button> </td>
    <td width=5>
    <td> <button class="btn svw2" onclick="rand()">Random</button> </td>
    <td width=5>
    <td> <button id=sbtn class="btn svw1" onclick="solve()">Solve</button> </td>
  </tr>
  <tr height=10>
  <tr>
    <td> <button class="btn svw1" onclick="clera()">Clear</button> </td>
    <td width=5> </td>
    <td> <button class="btn svw1" onclick="help()">Help</button> </td>
    <td width=5> </td>
    <td valign=top colspan=3 style=text-align:right translate=no>
        Search Time
        <input type=text name=stl id=stl maxlength=5
         style="font-size:.9em; height:24px; width:40px; border:none;
           border-radius:10px; padding-left:8px; border-radius:15px" value=5>
    </td>
  </tr>
  <tr height=10>
  <tr> 
    <td colspan=8>
      <div id=btn>
      </div>
     </td>
  </tr>
</table>

</td><td width=5%><td id=tdc valign=top>
<div id=cube style=width:290px;height:290px
     ondblclick="event.stopPropagation()">
</div>
<br>
<div id=status style=width:300px></div>
</td>
</tr><tr height=8></tr></table>
<div id=back> </div>
<br><br>

<script>

"use strict";

var stl;
var color;
var facelets_arr = [];
var stoplen = 0;
var stoplen_param = 0;
var cloze = 0;
var fnames = [];
var dist_loaded = [0, 0, 0];
var solve_running = 0;
var dist_files_loaded = 0;
var acjs_removeListeners = [];
var sbtn_bgcolor_active = "#aaaaaa";    // should match btn:active in style2.css
var sbtn_bgcolor_inactive = "#ffffff";  // should match btn background-color style2.css
var facelets;
var show_node_counts = 0;
var use_p2seq = 1;

var CUBE_HOME   = "RRRRRRRRRGGGYYYBBBWWWGGGYYYBBBWWWGGGYYYBBBWWWOOOOOOOOO";
var CUBE_BLANK  = "LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL";

var USE_DIST3 = 0;

var dist_gen_depth = 0;
var dist3_gen_depth = 0;
var distp2_gen_depth = 0;
var load_dist_files = 0;
var sol_dep1, sol_dep2, p1_nodes;
var show_deps = true;

var worker = new Worker(location.href.replace('html','js'));

main();

function main() {

  worker.addEventListener('message', ipc);

  var params = location.search.substr(1).split('&');

  for (var i=0; i < params.length; i++) {
    var p = params[i].split('=');
    if (typeof(p[1]) != 'undefined')
      window[p[0]] = p[1];
  }

  if (typeof(use_dist3) != 'undefined') {
    if (use_dist3 == 1 || use_dist3 == 2) {
      USE_DIST3 = use_dist3;
      dist3_gen_depth = 10;
      load_dist_files = 1;
      dist_loaded = [0, 0, 0, 0];
    }
  }

  if (isNaN(dist_gen_depth))
    dist_gen_depth = ((load_dist_files == 1) ? 9 : 8) 
  else {
    if (dist_gen_depth == 0)
      dist_gen_depth = ((load_dist_files == 1) ? 9 : 8) 
    else {
      var gen_max = ((load_dist_files == 1) ? 10 : 9);
      if (dist_gen_depth < 8)
        dist_gen_depth = 8;
      else if (dist_gen_depth > gen_max)
        dist_gen_depth = gen_max;
    }
  }

  if (typeof dist_gen_depth == 'string')
    dist_gen_depth = parseInt(dist_gen_depth);

  if (isNaN(distp2_gen_depth))
    distp2_gen_depth = 8;
  else {
    if (distp2_gen_depth == 0)
      distp2_gen_depth = 8;
    else {
      var gen2_max = ((load_dist_files == 1) ? 15 : 10);
      if (distp2_gen_depth < 8)
        distp2_gen_depth = 8;
      else if (distp2_gen_depth > gen2_max)
        distp2_gen_depth = gen2_max;
    }
  }

  if (load_dist_files == 1) {
    init_fnames();
    document.getElementById('btn').innerHTML =
      '<input type=file id=selectFiles style="display:none;" ' +
      'onchange="loadfiles(this.files)" multiple>' +
      '<button class="btn svw4" ' + 
      'onclick="document.getElementById(\'selectFiles\').click()" translate=no>Load Dist Files</button>';
  }

  if (typeof(stl) != 'undefined')
    document.getElementById('stl').value = stl;

  if (typeof(facelets) == 'undefined')
    facelets = CUBE_HOME;
  else {
    cloze = 1;
    if (facelets.length > 54)
      facelets = facelets.substr(0,54);
    if (facelets.length < 54)
      facelets = (facelets + CUBE_BLANK).substr(0,54);
    facelets = facelets.toUpperCase();
    var ftmp = facelets.split('');
    for (var i=0; i < 54; i++)
      if ('WYORGB'.indexOf(ftmp[i]) == -1)
        ftmp[i] = 'L';
    facelets = ftmp.join('');
  }

  if (typeof stoplen == 'string') {
    stoplen = stoplen.substr(0,2);
    if (!isnum(stoplen))
      stoplen = 0;
  }

  stoplen_param = (stoplen != 0) ? stoplen : 20;

  if (typeof snc == 'string')
    show_node_counts = snc;

  if (typeof show_node_counts == 'string') {
    show_node_counts = show_node_counts.substr(0,1);
    if (show_node_counts < '1' || show_node_counts > '3')
      show_node_counts = '0';
  }

  if (typeof use_p2seq == 'string') {
    if (use_p2seq == '0')
      use_p2seq = 0;
    else
      use_p2seq = 1;
  }

  update_layout();
  show_cube(0);

  if (cloze == 1)
    document.getElementById('back').innerHTML = '<a href="JavaScript:window.close()">Close</a>';
  else 
    document.getElementById('back').innerHTML = '<a href="javascript: history.go(-1)">Back</a>';
}

function isnum(s) {
  return /^\d+$/.test(s);
}

function loadfiles(files) {
  worker.postMessage({
    'cmd': 'readfiles',
    'files': files,
    'dist_gen_depth': dist_gen_depth,
    'use_dist3': USE_DIST3});
}

function update_layout()
{
  facelets_arr = facelets.split('');
  for (var i=0; i < 54; i++) {
    document.getElementById('f' + i).style.backgroundColor = color_str(facelets_arr[i]);
  }
}

function select_color(f)
{ 
  color = f.id;
}

function set_color(f)
{ 
  if (typeof(color) != 'undefined') {
    facelets_arr[f.id.substr(1)] = color;
    f.style.backgroundColor = color_str(color);
  }
}

function show() {
  if (solve_running == 1)
    return;
  if (facelets != facelets_arr.join('')) {
    facelets = facelets_arr.join('');
    show_cube(1);
  }
  else {
    if (msgtxt.length > 0)
      clear_status();
  }
}

function home()
{
  if (solve_running == 1)
    return;
  facelets = CUBE_HOME;
  if (CUBE_HOME != facelets_arr.join('')) {
    update_layout();
    show_cube(1);
  }
  else {
    if (msgtxt.length > 0)
      clear_status();
  }
}

function rand()
{
  if (solve_running == 1)
    return;
  facelets = randcube();
  update_layout();
  show_cube(1);
}

function clera()
{
  if (solve_running == 1)
    return;
  facelets = CUBE_BLANK;
  if (CUBE_BLANK != facelets_arr.join('')) {
    update_layout();
    show_cube(1);
  }
  else {
    if (msgtxt.length > 0)
      clear_status();
  }
}

function help()
{
  window.open(location.href.replace('.html', 'r_help.html'));
}

function solve() {
  if (solve_running == 1)
    return;
  sbtn_active();
  if (load_dist_files == 1) {
    if (dist_files_loaded == 0) {
      var need = '';
      for (var i=0, n=0; i < fnames.length; i++) {
        if (dist_loaded[i] == 0) { 
          need += fnames[i] + '<br>'; 
          n++;
        }
      }
      var str = (n==1) ? "this file" : "these files";
        document.getElementById('status').innerHTML = 
          'Load ' + str + ' before solving:<br>' + need;
        sbtn_inactive();
      return;
    }
  }
  stl = document.getElementById('stl').value + '';
  stl = stl.toLowerCase();
  var stlr = stl.replace(/ /g, '');
  if (stlr.length != stl.length) {
    document.getElementById('stl').value = stlr;
    stl = stlr;
  }
  if (stl == '') {
    stl = '5';
    document.getElementById('stl').value = 5;
  }
  msgtxt.length = 0;
  document.getElementById('status').style.textAlign = 'left';
  if (facelets != facelets_arr.join('')) {
    facelets = facelets_arr.join('');
    show_cube(1);
  }
  var verif = verify_main(facelets);
  if (verif == 0) {
    logtxt.length = 0;
    show_cube_layout(facelets);
    var v = stl.substr(stl.length-1);
    if (v == 's' || v == 't') {
      stoplen = (v=='s') ? stoplen_param : 0;
      stl = stl.substr(0, stl.length-1);
    }
    solve_running = 1;
    send_solve_request_to_worker();
  }
  else
  {
    sbtn_inactive();
    document.getElementById('status').innerHTML = msgtxt.join('');
  }
}

function send_solve_request_to_worker()
{
  worker.postMessage({
    'cmd': 'solve',
    'facelets': facelets,
    'stl': stl,
    'stoplen' : stoplen,
    'dist_gen_depth': dist_gen_depth,
    'load_dist_files': load_dist_files,
    'use_dist3': USE_DIST3,
    'show_node_counts': show_node_counts,
    'use_p2seq': use_p2seq});
}

function ipc(e) {
  var cmd = e.data.cmd;
  search_time = e.data.search_time;
  if (cmd == 'show_solution') {
    logtxt = e.data.logtxt;
    sol_dep1 = e.data.sol_dep1;
    sol_dep2 = e.data.sol_dep2;
    p1_nodes = e.data.p1_nodes;
    show_solution(e.data.moves);
    solve_running = 0;
  }
  if (cmd == 'msg')
    document.getElementById('status').innerHTML = e.data.msg;
  if (cmd == 'logtxt')
    show_log();
  if (cmd == 'dep9stat') {
    var s = 'Making Search Arrays<br>Generating to Depth 9<br>Progress: ';
    var n = (e.data.stat < 10) ? 10 : e.data.stat;
    document.getElementById('status').innerHTML = s + n + '%';
  }
  if (cmd == 'readFilesDone')
     readfiles_done()
  if (cmd == 'fileLoadStatus')
    dist_loaded = e.data.dist_loaded;
}

function show_solution(moves)
{
  sbtn_inactive();
  var af = cvt_to_anim(facelets);
  var params = animcube_params();
  if (params != '')
    af += params;
  acjs_removeListeners['cube']();
  AnimCube3("id=cube&config=../AnimCube.txt&edit=0&move=" + moves + "&facelets=" + af);
  document.getElementById('status').style.textAlign = 'center';
  var nodes = (p1_nodes < 1000 && moves.length > 0) ? ' &nbsp; ' + p1_nodes : '';
  var depths = (show_deps ? ' &nbsp; ' + sol_dep1 + '+' + sol_dep2 + nodes : '');
  document.getElementById('status').innerHTML = 
    '<button class=btn style="padding:2px 20px"' +
    'onclick="show_log()">Solve Log</button></td>' +
    '<table><tr height=10><td></table>' +
    '<a translate=no>' + search_time + depths + '</a>';
}

function show_cube(n)
{
  if (n) {
    clear_status();
    acjs_removeListeners['cube']();
  }
  var af = cvt_to_anim(facelets);
  var params = animcube_params();
  if (params != '')
    af += params;
  AnimCube3("id=cube&config=../AnimCube.txt&edit=0&facelets=" + af);
}

function clear_status()
{
  document.getElementById('status').innerHTML = '';
  msgtxt.length = 0;
  solution.length = 0;
}

function cvt_to_anim(c)
{
  var ca = new Array(54);

  var to_anim = [
    6,7,8,3,4,5,0,1,2,45,48,51,46,49,52,47,50,53,12,24,
    36,13,25,37,14,26,38,18,30,42,19,31,43,20,32,44,11,
    10,9,23,22,21,35,34,33,15,27,39,16,28,40,17,29,41];

  for (var i=0; i < 54; i++)
    ca[i] = c[to_anim[i]];

  return(ca.join(''));
}

function randcube()
{
  var cs = [];

  init_conv();
  copy(untwc,"021", 3, 0);  // for make_cubestr

  for (var i=0; i < 20; i++) {
    var ep = Math.floor(Math.random()*479001600);
    var et = Math.floor(Math.random()*2048);
    var cp = Math.floor(Math.random()*40320);
    var ct = Math.floor(Math.random()*2187);

    int_to_perm(cp, cps, 8);
    int_to_perm(ep, eps, 12);
    int_to_strp(ct, cts, 7, 3);
    int_to_strp(et, ets, 11, 2);

    if (parity(eps, 12) == parity(cps, 8))
      break;
  }
  make_cubestr();
  assign_centers_6c();
  colorize(cs);
  return(cs.join(''));
}

function colorize(cs)
{
  for (var i=0; i < 54; i++)
    if      (cubestr[i] == 0) cs[i] = 'B';
    else if (cubestr[i] == 1) cs[i] = 'Y';
    else if (cubestr[i] == 2) cs[i] = 'R';
    else if (cubestr[i] == 3) cs[i] = 'G';
    else if (cubestr[i] == 4) cs[i] = 'W';
    else if (cubestr[i] == 5) cs[i] = 'O';
}

function readfiles_done() {
  document.getElementById('status').innerHTML = 
    'All Dist Files Loaded<br>Ready to Solve';
  document.getElementById('btn').innerHTML = '';
  dist_files_loaded = 1;
}

var fs = 0;

function fullScreen(e) {
  if (typeof e.target.type != 'undefined')
    return;
  var fse = getFullscreenElement();
  if (typeof fse == 'undefined' || fse == null) {
    fs = 1;
    requestFullscreenFunc(document.body);
  }
  else {
    fs = 0;
    exitFullscreenFunc();
  }
}

function sbtn_active() {
  document.getElementById('sbtn').style.backgroundColor = sbtn_bgcolor_active;
}

function sbtn_inactive() {
  document.getElementById('sbtn').style.backgroundColor = sbtn_bgcolor_inactive;
}
</script>
</center>
</div>
</body>
</html>
