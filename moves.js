var R = [
   0, 1,14, 3, 4,26, 6, 7,38, 9,10,11,12,13,47,39,27,15,
   8,19,20,21,22,23,24,25,50,40,28,16, 5,31,32,33,34,35,
  36,37,53,41,29,17, 2,43,44,45,46,42,48,49,30,51,52,18
];

var U = [
   6, 3, 0, 7, 4, 1, 8, 5, 2,12,13,14,15,16,17,18,19,20,
   9,10,11,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,
  36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53
];
 
var F = [
   0, 1, 2, 3, 4, 5,35,23,11, 9,10,45,36,24,12, 6,16,17,
  18,19,20,21,22,46,37,25,13, 7,28,29,30,31,32,33,34,47,
  38,26,14, 8,40,41,42,43,44,39,27,15,48,49,50,51,52,53
];
  
var Um = [
   0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,16,17,
  18,19,20,24,25,26,27,28,29,30,31,32,21,22,23,33,34,35,
  36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53
];
  
var Fm = [
   0, 1, 2,34,22,10, 6, 7, 8, 9,48,11,12,13,14,15, 3,17,
  18,19,20,21,49,23,24,25,26,27, 4,29,30,31,32,33,50,35,
  36,37,38,39, 5,41,42,43,44,45,46,47,40,28,16,51,52,53
];

var Rm = [
   0,13, 2, 3,25, 5, 6,37, 8, 9,10,11,12,46,14,15,16,17,
  18, 7,20,21,22,23,24,49,26,27,28,29,30, 4,32,33,34,35,
  36,52,38,39,40,41,42, 1,44,45,43,47,48,31,50,51,19,53
];

var RL = [
   2, 1, 0, 5, 4, 3, 8, 7, 6,17,16,15,14,13,12,11,10, 9,
  20,19,18,29,28,27,26,25,24,23,22,21,32,31,30,41,40,39,
  38,37,36,35,34,33,44,43,42,47,46,45,50,49,48,53,52,51
];  

var UD = [
  51,52,53,48,49,50,45,46,47,33,34,35,36,37,38,39,40,41,
  42,43,44,21,22,23,24,25,26,27,28,29,30,31,32, 9,10,11,
  12,13,14,15,16,17,18,19,20, 6, 7, 8, 3, 4, 5, 0, 1, 2
];

var FB = [
   6, 7, 8, 3, 4, 5, 0, 1, 2,11,10, 9,20,19,18,17,16,15,
  14,13,12,23,22,21,32,31,30,29,28,27,26,25,24,35,34,33,
  44,43,42,41,40,39,38,37,36,51,52,53,48,49,50,45,46,47
];

var X = [
  12,13,14,24,25,26,36,37,38,11,23,35,45,46,47,39,27,15,
   8, 7, 6,10,22,34,48,49,50,40,28,16, 5, 4, 3, 9,21,33,
  51,52,53,41,29,17, 2, 1, 0,44,43,42,32,31,30,20,19,18
];

var Y = [
  33,21, 9,34,22,10,35,23,11,51,48,45,36,24,12, 6, 3, 0,
  20,32,44,52,49,46,37,25,13, 7, 4, 1,19,31,43,53,50,47,
  38,26,14, 8, 5, 2,18,30,42,39,27,15,40,28,16,41,29,17
];

var Z = [
   6, 3, 0, 7, 4, 1, 8, 5, 2,12,13,14,15,16,17,18,19,20, 
   9,10,11,24,25,26,27,28,29,30,31,32,21,22,23,36,37,38,
  39,40,41,42,43,44,33,34,35,47,50,53,46,49,52,45,48,51
];

var mv = [
  "R","R2","R'", "L","L2","L'", "U","U2","U'",
  "D","D2","D'", "F","F2","F'", "B","B2","B'",
  "E","E2","E'", "S","S2","S'", "M","M2","M'",
  "X","X2","X'", "Y","Y2","Y'", "Z","Z2","Z'",
  "Um","Um2","Um'", "Fm","Fm2","Fm'", "Rm","Rm2","Rm'",
  "Rc","Rc2","Rc'", "Fc","Fc2","Fc'", "Uc","Uc2","Uc'"
];

var moves = [];
var inv = [];

populate_moves();
populate_inv();

function do_moves(cube, sequence, inverse) {
  var c = cube;
  var fa = [];
  var ml = sequence.split(' ');
  if (inverse) {
    for (var i=ml.length-1; i >= 0; i--) {
      if (ml[i] != '') {
        var n = cvt_mv(ml[i]);
        if (n >= 0) {
          do_move(inv[n], c, fa);
          c = fa.join('');
        }
      }
    }
  }
  else {
    for (var i=0; i < ml.length; i++) {
      if (ml[i] != '') {
        var n = cvt_mv(ml[i]);
        if (n >= 0) {
          do_move(n, c, fa);
          c = fa.join('');
        }
      }
    }
  }
  return(c);
}

function do_move(mv, s1, s2) {
  for (var i=0; i < 54; i++)
    s2[i] = s1[moves[mv][i]];
}

function cvt_mv(s) {
  // make CCW half-twists CW
  if (s[1] == '2' && s[2] == '\'') s = s.substr(0,2);
  if (s[2] == '2' && s[3] == '\'') s = s.substr(0,3);
  for (var i=0; i < 54; i++) {
    if (mv[i] == s)
      return ((i > 35) ? i-18 : i);
  }
  console.log("Invalid Move: " +  s);
  return -1;
}

function populate_inv() {
  for (var i=0; i < 36; i++)
    inv[i] = Math.floor(i/3)*3 + 2-i%3;
}

function populate_moves() {
  for (var i=0; i < 54; i++)
    moves[i] = [];
  m1(R, 0);
  m2(RL, 0);
  m1(U, 6);
  m2(UD, 6);
  m1(F, 12);
  m2(FB,12);
  m1(Um, 18);
  m1(Fm, 21);
  m1(Rm, 24);
  m1(X, 27);
  m1(Y, 30);
  m1(Z, 33);
}

function m1(m, n) {
  for (var i=0; i < 54; i++)
    moves[n][i] = m[i];
  m1a(m, moves[n], moves[n+1]);
  m1a(m, moves[n+1], moves[n+2]);
}

function m1a(m, s1, s2) {
  for (var i=0; i < 54; i++)
    s2[i] = m[s1[i]];
}

function m2(m, n) {
  m2a(m, moves[n+2], moves[n+3]);
  m2a(m, moves[n+1], moves[n+4]);
  m2a(m, moves[n], moves[n+5]);
}

function m2a(m, s1, s2) { 
  for (var i=0; i < 54; i++)
    s2[i] = m[s1[m[i]]];
}

